# Тест конкурентного случайного чтения

Тест выполняет конкурентное чтение случайно выбранных записей по первичному ключу пачками по 1000 записей. Результат теста - стабильно достигаемое значение количества операций чтения строк в секунду.

Структура  используемой таблички:

```sql
 CREATE TABLE hashes(hash UInt64 NOT NULL, src Text, PRIMARY KEY(hash))
 WITH(AUTO_PARTITIONING_BY_LOAD=ENABLED,
      AUTO_PARTITIONING_MIN_PARTITIONS_COUNT=200,
      AUTO_PARTITIONING_MAX_PARTITIONS_COUNT=300,
      AUTO_PARTITIONING_PARTITION_SIZE_MB=500);
```

## Описание реализации теста

Обращения к YDB выполняются программой apirx_test, двоичный дистрибутив в виде jar-архива [доступен в разделе релизов](https://github.com/zinal/apirx-demo/releases/). Для работы программы apirx_test требуется OpenJDK 17 или выше (на более ранних не проверялось).

Настроечный файл для подключения к YDB при запуске программы apirx_test должен размещаться в текущем каталоге и иметь имя `apirx_test.xml`. Пример файла:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
<entry key="url">grpc://ydb-d1:2136/?database=/Root/testdb</entry>
<entry key="auth.mode">NONE</entry> <!-- NONE, SAKEY, META, LOGIN -->
<entry key="auth.user">username</entry>
<entry key="auth.password">password</entry>
<entry key="sakey.file">sakey.json</entry>
<entry key="pool.max">1000</entry>
<!-- <entry key="ca.file">ca.crt</entry> -->
</properties>
```

## Запуск теста

Запуск программы apirx_test:

```bash
java -jar apirx_test-1.0-SNAPSHOT.jar
```

Генерация данных выполняется сценарием JMeter при работающей на том же хосте программе apirx_test:

```bash
./jmeter/bin/jmeter -n -t run-generate.jmx
```

Тест выполняется сценарием JMeter при работающей на том же хосте программе apirx_test:

```bash
./jmeter/bin/jmeter -n -t run-read.jmx
```

При выполнении сценария измеряется количество выполненных операций и средняя интенсивность их выполнения на каждом интервале и в целом за время выполнения теста. Данные выводятся на экран. При запуске тестов с нескольких хостов данные о средней пропускной способности каждого хоста необходимо суммировать при оценке суммарной пропускной способности.

После запуска теста необходимо дождаться стабилизации количества шардов рабочей таблицы, и принимать в расчёт измерения после стабилизации.

## Автоматическое развертывание кластера YDB для теста

В каталоге [yc-config](./yc-config/) подготовлен набор скриптов для автоматического развертывания и настройки кластера YDB для проведения теста.

> [!WARNING]  
> Предлагаемый порядок развертывания кластера YDB не следует использовать для производственных инсталляций, поскольку в нём для упрощения исключено использование TLS и аутентификации, и отсутствует отказоустойчивость YDB.

Развертывание кластера и подготовка к тесту осуществляются путём выполнения набора шагов:

1. Создать виртуальную машину "подскока" с ОС Linux, доступную по протоколу SSH с рабочего места, на котором выполняется настройка.
1. [Установить](https://cloud.yandex.ru/docs/cli/operations/install-cli) и [настроить по инструкции](https://cloud.yandex.ru/docs/cli/operations/authentication/service-account) YC CLI на рабочем месте. Права доступа сервисного аккаунта должны позволять создавать диски и виртуальные машины.
1. Убедиться в наличии достаточных квот для создания виртуальных машин и дисков. При использовании предлагаемых настроек требуется (без учёта ресурсов других виртуальных машин, в том числе виртуальной машины "подскока"):
    * 200 vCPU;
    * 368 Гбайт оперативной памяти
    * 650 Гбайт дискового пространства типа network-ssd
    * 1674 Гбайт дискового пространства типа network-ssd-nonreplicated
1. Создать файл `options.sh` на основе [предложенного шаблона](./yc-config/options.sh.template). При изменении настоек следует учитывать следующие соображения:
    * `data_disk_count`: изменение количества дисков для хранения данных требует корректировки конфигурационных файлов кластера YDB для [статического](./yc-config/ydbconf/storage.yaml) и [динамических](./yc-config/ydbconf/dynamic.yaml) узлов;
    * `prefix_static`: при изменении префикса имени узла хранения данных также необходимо скорректировать конфигурационные файлы кластера YDB;
    * `cpu_static`: количество vCPU для узла хранения данных не может быть менее 24 при подключении 9 дисков с данными из-за ограничений в платформе Yandex.Cloud;
    * `data_disk_size`: при использовании типа диска `network-ssd-nonreplicated` размер диска должен быть кратен 93 Гбайт;
    * `mem_dynamic`: уменьшение объёма оперативной памяти менее 32 Гбайт требует сокращения размера кеша данных в файле конфигурации [динамических](./yc-config/ydbconf/dynamic.yaml) узлов YDB;
    * `cpu_dynamic`: изменение количества vCPU необходимо учесть в секции `actor_system_config` файла конфигурации [динамических](./yc-config/ydbconf/dynamic.yaml) узлов YDB.
1. Создать диски и виртуальные машины через `01-create-vms.sh`.
1. Настроить виртуальные машины путём через `02-configure-vms.sh`.
1. Загрузить и распаковать на виртуальных машинах необходимое программное обеспечение через `03-setup.sh`.
1. Создать кластер и базу данных YDB через `04-ydb-deploy.sh`.
1. Проверить доступность кластера YDB путём подключения Web-браузером на порт 8765 виртуальной машины хранения данных. Сетевой доступ можно организовать с помощью SSH-туннеля:
    * запустить на рабочем месте команду `ssh -L8765:ydb-s1:8765 gw0 vmstat 5 9999999999`;
    * подключиться Web-браузером к адресу [http://127.0.0.1:8765/](http://127.0.0.1:8765/).
1. Запустить загрузку данных через `05-load-data.sh`.
1. Дождаться завершения загрузки данных и убедиться в отсутствии ошибок:
    * наличии 1 млрд. записей в таблице `hashes`;
    * отсутствии ошибок в файле `run-generate.log`, размещённом на первом из узлов подачи нагрузки.
